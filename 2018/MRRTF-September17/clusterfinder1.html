<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>High Energy Collisions Investigations</title>

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
		<link href='//cdn.jsdelivr.net/devicons/1.8.0/css/devicons.min.css' rel='stylesheet'>
        <link rel="stylesheet" href="https://cdn.rawgit.com/konpa/devicon/df6431e323547add1b4cf45992913f15286456d3/devicon.min.css">
		<link rel="stylesheet" href="https://aphecetche.netlify.com/reveal/css/reveal.min.css">


		<link rel="stylesheet" href="https://aphecetche.netlify.com/reveal/css/theme/lasimple.css" id="theme">


		

		<link rel="stylesheet" href="https://aphecetche.netlify.com/reveal/lib/css/tomorrow-night.css">

		
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'https:\/\/aphecetche.netlify.com\/reveal/css/print/pdf.css' : 'https:\/\/aphecetche.netlify.com\/reveal/css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		
	</head>


	<body>

		<div class="reveal">

			<div class="slides">

				<section class="title-slide" data-markdown
             data-separator="(^---$|^---\?.*)"
             data-separator-vertical="(^\+\+\+$|^\+\+\+\?.*)"
             data-separator-notes="^Note:"
			 data-charset="utf-8"
			 data-state="title-slide">
# MUON Cluster Finder Run2/3


##  


### Sean Murray

#### 17 September 2018
#### Template "borrow" from Laurent ;-)
</section>

<section data-markdown
             data-separator="(^---$|^---\?.*)"
             data-separator-vertical="(^\+\+\+$|^\+\+\+\?.*)"
             data-separator-notes="^Note:"
			 data-charset="utf-8"
			 data-state="regular-slide">
			 ## (part of) Muon is finally in sim

### [PR1144](https://github.com/AliceO2Group/AliceO2/pull/1144)

- MCH geometry
- MCH (very) basic hits

&gt; Progressive enhancement philosophy :  
&gt; 
&gt; start simple and then refine...

---

---

### Tried to get minimal interfaces/exports

&lt;pre class=&#34;hljs&#34;&gt;
├── include
│   └── MCHSimulation
&lt;/pre&gt;
&lt;pre class=&#34;hljs stress&#34;&gt;
│       ├── Detector.h
│       ├── Geometry.h
│       ├── GeometryTest.h
│       └── Hit.h
&lt;/pre&gt;
&lt;pre class=&#34;hljs&#34;&gt;
├── macros
│   ├── drawMCHGeometry.C
├── src
│   ├── Detector.cxx
│   ├── Geometry.cxx
│   ├── GeometryTest.cxx
│   ├── Hit.cxx
│   ├── Materials.cxx
│   ├── Materials.h
│   ├── Station1Geometry.cxx
│   ├── Station1Geometry.h
│   ├── Station2Geometry.cxx
│   ├── Station2Geometry.h
│   ├── Station345Geometry.cxx
│   ├── Station345Geometry.h
│   ├── Stepper.cxx
│   └── Stepper.h
└── test
    ├── CMakeLists.txt
    └── testGeometry.cxx
&lt;/pre&gt;

---

#### `Geometry.h`

```c&#43;&#43;

namespace o2 { namespace mch {

/// createGeometry creates MCH geometry and attach it to existing topVolume
void createGeometry(TGeoVolume&amp; topVolume);

/// get a list of MCH sensitive volumes
std::vector&lt;TGeoVolume*&gt; getSensitiveVolumes();

/// get the local-to-global transformation for a given detection element
o2::Transform3D getTransformation(int detElemId, const TGeoManager&amp; geo);

}}
```

---

#### `Hit.h`

#### Maybe too minimal
#### Will have to see when implementing digitizer

```c&#43;&#43;
namespace o2 { namespace mch {

class Hit : public ::o2::BasicXYZEHit&lt;float&gt;
{
 public:
  Hit(int trackId = 0, 
      short detElemId = 0, 
      Point3D&lt;float&gt; entrancePoint = {}, 
      const Point3D&lt;float&gt; exitPoint = {},
      float eloss = 0.0, 
      float length = 0.0, 
      float tof = 0.0);  

  Point3D&lt;float&gt; entrancePoint() const;
  Point3D&lt;float&gt; exitPoint() const;

  short detElemId() const;

 private:
  float mLength = {};
  Point3D&lt;float&gt; mExitPoint = {};
  ClassDefNV(Hit, 1);
};

}}
```

&lt;/div&gt;

---

## Separation of concerns

`Detector` = {geo creation (functions), hit creation (class)}

```c&#43;&#43;
namespace o2 { namespace mch {

Detector::Detector(bool active)
  : o2::Base::DetImpl&lt;Detector&gt;(&#34;MCH&#34;, active), mStepper{ new o2::mch::Stepper } {}

void Detector::defineSensitiveVolumes() {
  for (auto* vol : getSensitiveVolumes()) {
    AddSensitiveVolume(vol);
  }
}

void Detector::Initialize() {
  defineSensitiveVolumes();
  o2::Base::Detector::Initialize();
}

void Detector::ConstructGeometry() {
  createGeometry(*top);
}

Bool_t Detector::ProcessHits(FairVolume* v) {
  mStepper-&gt;process(*fMC);
  return kTRUE;
}

std::vector&lt;o2::mch::Hit&gt;* Detector::getHits(int i) {
  if (i == 0) {
    return mStepper-&gt;getHits();
  }
  return nullptr;
}

void Detector::Register()
{
  // TODO : get another way to do I/O (i.e. separate concerns)

  mStepper-&gt;registerHits(addNameTo(&#34;Hit&#34;).c_str());
}

void Detector::EndOfEvent() { mStepper-&gt;resetHits(); }

}} 
``` 

---

#### `GeometryTest.h`

#### Mostly debug utilities for geometry development

```c&#43;&#43;
namespace o2 { namespace mch { namespace test {

/// creates MCH geometry from scratch (i.e. from a null TGeoManager)
/// usefull for tests or drawing for instance.
void createStandaloneGeometry();

/// tree like textual dump of the geometry nodes
void showGeometryAsTextTree(const char* fromPath = &#34;&#34;, int maxdepth = 2, std::ostream&amp; out = std::cout);

/// basic drawing of the geometry
void drawGeometry();

/// set the volume and daughter visibility for all volumes with a name matching the regexp pattern
void setVolumeVisibility(const char* pattern, bool visible, bool visibleDaughters);

/// set the volume line and fill for all volumes with a name matching the regexp pattern
void setVolumeColor(const char* pattern, int lineColor, int fillColor);
inline void setVolumeColor(const char* pattern, int color)
{
  setVolumeColor(pattern, color, color);
}

/// get a radlen radiograph of a given detection element within box with the given granularity
TH2* getRadio(int detElemId, float xmin, float ymin, float xmax, float ymax, float xstep, float ystep, float thickness = 5 /* cm */);

}}} 
```

---

## Currently in the works

### Geometry fixes
#### Uniformize level of details (St 2 &lt; St345 &lt; St1) ?
#### Global positioning adjustments
#### Adding electronic chips

### Hit pos fix

---

## Currently in the works

### Radiographer
#### To get a map of `&lt;X/X0&gt;` for detection elements
#### To be added to tests

---

## Next in the works

### MID geometry
### MID hits

---

## On a longer term

### Digitizer
### Improved hits

&gt; Both are linked

&gt; Ideally informed by next test beam

&gt; Not before automn ?


---

&lt;!-- .slide: data-state=&#34;secondary-slide&#34; --&gt;

# Misc

## aka Backup slides

---

## TGeo vs TVirtualMC

### create geometry w/o a prior VMC instance

### [PR1113](https://github.com/AliceO2Group/AliceO2/pull/1113)

### not completely successfull
### but functional

---

### Compact geo creation

```c&#43;&#43;
void createStandaloneGeometry()
{
  if (gGeoManager &amp;&amp; gGeoManager-&gt;GetTopVolume()) {
    std::cerr &lt;&lt; &#34;Can only call this function with an empty geometry, i.e. gGeoManager==nullptr &#34;
              &lt;&lt; &#34; or gGeoManager-&gt;GetTopVolume()==nullptr\n&#34;;
  }
  TGeoManager* g = new TGeoManager(&#34;MCH-ONLY&#34;, &#34;ALICE MCH Standalone Geometry&#34;);
  TGeoVolume* top = createAirVacuumCave(&#34;cave&#34;);
  g-&gt;SetTopVolume(top);
  o2::mch::createGeometry(*top);
}
```

### no VMC needed here

&gt; easy to include in a unit test

---

## Buckets dependencies snag

### Change 1 MCH sim file


```shell
[build] Starting build
[proc] Executing command: /usr/local/bin/cmake --build /Users/laurent/alice/sw/BUILD/O2-latest-dpl-mch-test/O2 --config RelWithDebInfo --target all -- -j 10
[build] [1/11] Running utility command for svnheader
[build] [2/11] Building CXX object Detectors/MUON/MCH/Simulation/CMakeFiles/MCHSimulation.dir/src/GeometryTest.cxx.o
[build] [3/11] Linking CXX shared library lib/libMCHSimulation.dylib
[build] [4/11] Linking CXX executable bin/o2sim_parallel
[build] [5/11] Linking CXX executable bin/o2sim
[build] [6/11] Linking CXX executable bin/o2ITSClusterizers
[build] [7/11] Linking CXX executable bin/runTPC
[build] [8/11] Linking CXX executable bin/o2TPCSimulation
[build] [9/11] Linking CXX executable bin/O2HitMergerRunner
[build] [10/11] Linking CXX executable bin/O2PrimaryServerDeviceRunner
[build] [11/11] Linking CXX executable bin/O2SimDeviceRunner
[build] Build finished with exit code 0
```

### Get a relink of too many executables ?

---

### showGeometryAsTextTree

```console
root [0] o2::mch::test::createStandaloneGeometry()
root [1] o2::mch::test::showGeometryAsTextTree(&#34;/cave&#34;,2)
cave_1
├──SC01I_0
│  ├──Quadrant (chamber 1)_101
│  └──Quadrant (chamber 1)_102
├──SC01O_1
│  ├──Quadrant (chamber 1)_100
│  └──Quadrant (chamber 1)_103
...
├──SC05I_8
│  ├──Chamber 5 support panel_8
│  ├──122000SR1_500
│  ├──112200SR2_501
│  ├──122200S_502
│  ├──222000N_503
│  ├──220000N_504
│  ├──220000N_514
```

			</section>

			</div>


<nav>
	
				<a class="button home" href="/" role="button"></a>
	
	
				<a class="button print" href="?print-pdf" role="button"></a>
	
</nav>

<footer>L. Aphecetche | WP12 Muon Status | June 13th 2018 </footer>


		</div>


		<script src="https://aphecetche.netlify.com/reveal/lib/js/head.min.js"></script>
		<script src="https://aphecetche.netlify.com/reveal/js/reveal.min.js"></script>

		<script>

			
			
			Reveal.initialize({

				width: 1024,
				height: 768,
				pdfMaxPagesPerSlide: 1,
				


				controls: false,


				progress: true,

				history: true,

				center:  true ,


				slideNumber: true,


				transition: "none",

				
				dependencies: [
					{ src: 'https:\/\/aphecetche.netlify.com\/reveal/lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'https:\/\/aphecetche.netlify.com\/reveal/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'https:\/\/aphecetche.netlify.com\/reveal/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'https:\/\/aphecetche.netlify.com\/reveal/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'https:\/\/aphecetche.netlify.com\/reveal/plugin/zoom-js/zoom.js', async: true },
					{ src: 'https:\/\/aphecetche.netlify.com\/reveal/plugin/notes/notes.js', async: true },
					{ src: 'https:\/\/aphecetche.netlify.com\/reveal/plugin/svgicons/svgicons.js', async: true }
				]
			});

Reveal.addEventListener( 'secondary-slide', function() {
    
    var state = Reveal.getState();
    var s = Reveal.getSlide(state.indexh,state.indexv);
    s.classList.add('secondary-title-slide');
    s.getElementsByTagName('h1')[0].classList.add('center');
}, false );

Reveal.addEventListener( 'timeline', function() {
    drawTimeline();
}, false );		

Reveal.addEventListener( 'regular-slide', function() {
	var footer = document.querySelector(".reveal footer");
	if (footer) {
		footer.style.display = 'block';
	}
},false );

Reveal.addEventListener( 'title-slide', function() {
	var footer = document.querySelector(".reveal footer");
	if (footer) {
		footer.style.display = 'none';
	}
}, false );		


</script>


	</body>
</html>
